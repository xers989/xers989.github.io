<!DOCTYPE html><html lang="en-GB"><head> <!-- General meta --><meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --><meta name="generator" content="Jekyll v3.8.5" /><meta property="og:title" content="WAF SQL Injection" /><meta name="author" content="Jake Kim" /><meta property="og:locale" content="en_US" /><meta name="description" content="OWASP SQL Injection 첫 번째로 WAF를 이용하여 SQL Injection 공격을 감지하고 이를 막는 방법을 알아보겠다. SQL 인젝션은 웹 사이트의 보안의 헛점을 이용하여 특정 SQL 쿼리 문을 전송하여 데이터베이스로 부터 데이터를 탈취하는 해킹 기법을 말한다. 클라이언트의 입력을 제대로 필터링 하지 못하여 발생하며 그 피해는 치명적일 수 있어 항상 가장 높은 위협 순위로 꼽히곤 한다. 예를 들어 사용자를 조회 하는 SQL과 웹페이지를 예로 들면 id를 받아서 테이블에서 조회하고 결과를 반환하는 형태일 것이다. 웹페이지는 아마도 http://**/user?id=gildong 형태로 조회 할 것이다. 실행 되는 SQL은 아마도 select id from user where id = ‘gildong’ 과 같을 것이다. 공격자는 SQL을 예측하여 쿼리를 수정하여 gildong’ or ‘1’=’1 형식으로 작성하면 실행되는 SQL은 select id from user where id = ‘gildong’ or ‘1’ = ‘1’ 로 변경되어 실행 되어 user 테이블로 부터 정보를 탈취할 수 있다. 이러한 공격 방법은 매우 다양하다. 다양한 공격 방법 중 2가지 전통적인 SQL injection 을 우선 소개 하겠다. Error based SQL Injection or ‘1’=’1’ 과 같은 문장을 추가 하여 항상 참이 되게 하여 공격하는 방법 이다. 로그인 과정에서 사용될 수 있는 Select * from user where id=’gildong’ and password=’abcd’ 를 예측하고 공격을 Select * from user where id=’gildong’ and password =’none’ or ‘1’=’1’ 이 실행되도록 하면 문장이 항상 참이기 때문에 로그인이 성공 하게 된다. UNION based SQL Injection SQL 의 Union 문장을 이용하여 추가 SQL이 실행 되도록 하는 공격 방법이다. 테이블의 정보를 탈취하고자 할 때 사용 될 수 있다. Select id from user where id=’gildong’ and password=’none’ union select id from user where ‘1’=’1’ 과 같이 변경하여 주면 모든 id를 조회 하게 된다. SQL Injection Detect WAF 를 이용한 SQL Injection 을 보기 위한 WAF 는 이전에 설정한 WAF 환경과 Web application (DVWA)를 이용할 것이다. 2개가 SQL Injection을 검출하기 위해 해당 공격을 감지 하도록 WAF의 Protect Rule을 설정 하여야 한다. OCI의 WAF 설정으로 들어간다. (Security 탭의 WAF Policies) WAF를 설정한 Compartment를 선택 하고 등록된 waf policy를 클릭 Protection Rules에서 SQL Injection의 Action을 Detect 로 변경 하여 준다. Classic SQL Injection probings, Common SQL Injects를 선택 하고 Detect를 선택 한다. 변경된 설정은 바로 적용되지 않고 unpublished 상태로 있게 된다. 변경이 감지되면 상단에 unpublished list에 나오게 되며 Publish All 버튼을 눌러주면 글로벌하게 변경된 정책이 적용 된다. 변경된 정책의 적용에 수분이 소요 됨으로 잠시 대기 하여 준다. 적용이 완료 되면 Active 상태가 된다. Error based SQL Injection Attack SQL Injection 공격을 위해 웹애플리케이션에 로그인 한다. http://waf.korwaf.site/ 에 로그인 하면 메뉴 중 SQL Injection을 클릭 한다. 공격을 위해 1을 입력 하고 Submit을 누르면 아래 처럼 1번에 대한 사용자 정보가 출력 되는 것을 볼 수 있다. 공격을 위해 다음과 같이 입력 하고 Submit을 클릭 하면 1&#39; or &#39;1&#39;=&#39;1&#39; 아래 처럼 테이블에 정보가 조회 되는 것을 볼 수 있다. 이로서 테이블에는 admin, Gordon, Hack, Pablo, Bob 등이 있다는 것을 알 수 있다 WAF의 SQL Injection 감지 WAF Policies에서 Metrics 를 보면 Detect 된 요청의 건수를 보여주는 대시보드를 볼 수 있다. 분단위로 조회 하였음으로 3 건 혹은 1건식 Detect 된 내용이 있음을 알 수 있다. 상세 내용을 보기 위해 Logs 를 클릭 하여 조회 조건 중 Action 에서 Detect 를 선택 하고 조회 한다. Detect 된 리스트를 볼 수 있으며 상세 각 라인별로 간략한 내용을 볼 수 있다. 접근을 시도한 지역과 User Agent 즉, 브라우저 정보를 볼 수 있다. 상세한 내용을 보기 위한 View JSON 을 클릭 한다. { &quot;action&quot;: &quot;DETECT&quot;, &quot;clientAddress&quot;: &quot;203.234.105.56&quot;, &quot;countryName&quot;: &quot;Republic of Korea&quot;, &quot;userAgent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0&quot;, &quot;domain&quot;: &quot;waf.korwaf.site&quot;, &quot;protectionRuleDetections&quot;: { &quot;959071&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: &#39; or &#39;1&#39;= found within ARGS:id: 1&#39; or &#39;1&#39;=&#39;1&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:\\\\bor\\\\b ?(?:\\\\d{1,10}|[\\\\&#39;\\\&quot;][^=]{1,10}[\\\\&#39;\\\&quot;]) ?[=&lt;&gt;]+|(?i:&#39;\\\\s+x?or\\\\s+.{1,20}[+\\\\-!&lt;&gt;=])|\\\\b(?i:x?or)\\\\b\\\\s+(\\\\d{1,10}|&#39;[^=]{1,10}&#39;)|\\\\b(?i:x?or)\\\\b\\\\s+(\\\\d{1,10}|&#39;[^=]{1,10}&#39;)\\\\s*?[=&lt;&gt;])\&quot; at ARGS:id.&quot; }, &quot;981242&quot;: { &quot;Message&quot;: &quot;Detects classic SQL injection probings 1/2. Matched attack string: [1&#39; or &#39;1&#39;=&#39;1] in [ARGS:id];&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:(?:[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\s*?(x?or|div|like|between|and)\\\\s*?[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]?\\\\d)|(?:\\\\\\\\x(?:23|27|3d))|(?:^.?[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]$)|(?:(?:^[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98\\\\\\\\]*?(?:[\\\\ ...\&quot; at ARGS:id.&quot; }, &quot;981243&quot;: { &quot;Message&quot;: &quot;Detects classic SQL injection probings 2/2. Matched attack string: [1&#39; or &#39;1&#39;=&#39;1] in [ARGS:id];&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:(?:[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\s*?\\\\*.+(?:x?or|div|like|between|and|id)\\\\W*?[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\d)|(?:\\\\^[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98])|(?:^[\\\\w\\\\s\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98-]+(?&lt;=and\\\\s)(?&lt;=or|xor ...\&quot; at ARGS:id.&quot; } }, &quot;httpMethod&quot;: &quot;GET&quot;, &quot;requestUrl&quot;: &quot;/vulnerabilities/sqli/?id=1%27+or+%271%27%3D%271&amp;Submit=Submit&quot;, &quot;httpHeaders&quot;: { &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;en-US,en;q=0.5&quot;, &quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Connection&quot;: &quot;keep-alive&quot;, &quot;Cookie&quot;: &quot;PHPSESSID=d5ndqi2g5olrddv02qjp8bvdk0; security=low&quot;, &quot;Host&quot;: &quot;waf.korwaf.site&quot;, &quot;Referer&quot;: &quot;http://waf.korwaf.site/vulnerabilities/sqli/?id=admin%27+or+1%3D1+%23&amp;Submit=Submit&quot;, &quot;Request-Id&quot;: &quot;2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0&quot;, &quot;X-Client-Ip&quot;: &quot;203.234.105.56&quot;, &quot;X-Country-Code&quot;: &quot;KR&quot;, &quot;X-Forwarded-For&quot;: &quot;203.234.105.56&quot; }, &quot;httpVersion&quot;: &quot;HTTP/1.1&quot;, &quot;incidentKey&quot;: &quot;2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ&quot;, &quot;countryCode&quot;: &quot;KR&quot;, &quot;timestamp&quot;: &quot;Thu, 12 Mar 2020 12:26:13 GMT&quot;, &quot;logType&quot;: &quot;PROTECTION_RULES&quot; } 위 내용을 보고 접속한 클라이 언트의 상세 정보를 볼 수 있으며 protectionRuleDetections 을 보면 http://waf.korwaf.site/vulnerabilities/sqli 페이지에서 SQL Injection Attack 이 감지 된 것을 알 수 있으며 감지된 데이터는 ‘ or ‘1’= 이며 전달된 변수는 id 란 것을 알 수 있다. 다시 웹애플리케이션으로 돌아가 View Source를 클릭 하면 다음과 같은 코드로 작성되어 있음을 볼 수 있다. &lt;?php if( isset( $_REQUEST[ &#39;Submit&#39; ] ) ) { // Get input $id = $_REQUEST[ &#39;id&#39; ]; // Check database $query = &quot;SELECT first_name, last_name FROM users WHERE user_id = &#39;$id&#39;;&quot;; $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;], $query ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;/pre&gt;&#39; ); // Get results while( $row = mysqli_fetch_assoc( $result ) ) { // Get values $first = $row[&quot;first_name&quot;]; $last = $row[&quot;last_name&quot;]; // Feedback for end user echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;; } mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]); } ?&gt; SQL 실행이 $id 로 직접 웹페이지의 Query 파라미터를 받아 sql 문자열을 만든 후에 실행 되는 형태로 작성하여 SQL injection 공격에 취약해 진것을 볼 수 있다. 공격이 감지 되었음으로 코드를 수정하여 대비하거나 WAF 의 Protection Rule 의 Action을 block 으로 하여 해당 접근을 차단 할 수 있다. UNION based SQL Injection Detect Union based Injection 공격을 위해 웹애플리케이션의 SQL Injection을 클릭 한다. 공격을 위해 다음과 같이 union 을 포함하여 작성 한 후 submit 을 클릭 한다. &#39; union all select user_id as first_name, first_name from users # 결과는 다음과 같이 출력 된다. union all 로 원하는 SQL 을 실행 시켰으며 # 을 붙여 주어 뒤에 올 수 있는 SQL 문장을 주석으로 처리 하도록 한 것이다. 이로서 user_id는 1,2,3,4,5 가 있다는 것을 알 수 있다. WAF의 SQL Injection 감지 WAF Policies 의 logs 를 조회 하여 보면 Detect 가 된 요청을 볼 수 있다. View JSON 을 클릭 하면 아래와 같은 메시지를 볼 수 있으며 id 변수에 union all select user_id as first_name, first_name from users # 이란 변수가 전달 되어 SQL Injection 으로 의심되는 패턴이 입력 되어 감지 된 것을 알 수 있다. &quot;protectionRuleDetections&quot;: { &quot;950001&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: union all select found within ARGS:id: &#39; union all select user_id as first_name, first_name from users #&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:\\\\b(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4| ...\&quot; at ARGS:id.&quot; }, &quot;959073&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: union all select found within ARGS:id: &#39; union all select user_id as first_name, first_name from users #&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4|ipv ...\&quot; at ARGS:id.&quot; } }," /><meta property="og:description" content="OWASP SQL Injection 첫 번째로 WAF를 이용하여 SQL Injection 공격을 감지하고 이를 막는 방법을 알아보겠다. SQL 인젝션은 웹 사이트의 보안의 헛점을 이용하여 특정 SQL 쿼리 문을 전송하여 데이터베이스로 부터 데이터를 탈취하는 해킹 기법을 말한다. 클라이언트의 입력을 제대로 필터링 하지 못하여 발생하며 그 피해는 치명적일 수 있어 항상 가장 높은 위협 순위로 꼽히곤 한다. 예를 들어 사용자를 조회 하는 SQL과 웹페이지를 예로 들면 id를 받아서 테이블에서 조회하고 결과를 반환하는 형태일 것이다. 웹페이지는 아마도 http://**/user?id=gildong 형태로 조회 할 것이다. 실행 되는 SQL은 아마도 select id from user where id = ‘gildong’ 과 같을 것이다. 공격자는 SQL을 예측하여 쿼리를 수정하여 gildong’ or ‘1’=’1 형식으로 작성하면 실행되는 SQL은 select id from user where id = ‘gildong’ or ‘1’ = ‘1’ 로 변경되어 실행 되어 user 테이블로 부터 정보를 탈취할 수 있다. 이러한 공격 방법은 매우 다양하다. 다양한 공격 방법 중 2가지 전통적인 SQL injection 을 우선 소개 하겠다. Error based SQL Injection or ‘1’=’1’ 과 같은 문장을 추가 하여 항상 참이 되게 하여 공격하는 방법 이다. 로그인 과정에서 사용될 수 있는 Select * from user where id=’gildong’ and password=’abcd’ 를 예측하고 공격을 Select * from user where id=’gildong’ and password =’none’ or ‘1’=’1’ 이 실행되도록 하면 문장이 항상 참이기 때문에 로그인이 성공 하게 된다. UNION based SQL Injection SQL 의 Union 문장을 이용하여 추가 SQL이 실행 되도록 하는 공격 방법이다. 테이블의 정보를 탈취하고자 할 때 사용 될 수 있다. Select id from user where id=’gildong’ and password=’none’ union select id from user where ‘1’=’1’ 과 같이 변경하여 주면 모든 id를 조회 하게 된다. SQL Injection Detect WAF 를 이용한 SQL Injection 을 보기 위한 WAF 는 이전에 설정한 WAF 환경과 Web application (DVWA)를 이용할 것이다. 2개가 SQL Injection을 검출하기 위해 해당 공격을 감지 하도록 WAF의 Protect Rule을 설정 하여야 한다. OCI의 WAF 설정으로 들어간다. (Security 탭의 WAF Policies) WAF를 설정한 Compartment를 선택 하고 등록된 waf policy를 클릭 Protection Rules에서 SQL Injection의 Action을 Detect 로 변경 하여 준다. Classic SQL Injection probings, Common SQL Injects를 선택 하고 Detect를 선택 한다. 변경된 설정은 바로 적용되지 않고 unpublished 상태로 있게 된다. 변경이 감지되면 상단에 unpublished list에 나오게 되며 Publish All 버튼을 눌러주면 글로벌하게 변경된 정책이 적용 된다. 변경된 정책의 적용에 수분이 소요 됨으로 잠시 대기 하여 준다. 적용이 완료 되면 Active 상태가 된다. Error based SQL Injection Attack SQL Injection 공격을 위해 웹애플리케이션에 로그인 한다. http://waf.korwaf.site/ 에 로그인 하면 메뉴 중 SQL Injection을 클릭 한다. 공격을 위해 1을 입력 하고 Submit을 누르면 아래 처럼 1번에 대한 사용자 정보가 출력 되는 것을 볼 수 있다. 공격을 위해 다음과 같이 입력 하고 Submit을 클릭 하면 1&#39; or &#39;1&#39;=&#39;1&#39; 아래 처럼 테이블에 정보가 조회 되는 것을 볼 수 있다. 이로서 테이블에는 admin, Gordon, Hack, Pablo, Bob 등이 있다는 것을 알 수 있다 WAF의 SQL Injection 감지 WAF Policies에서 Metrics 를 보면 Detect 된 요청의 건수를 보여주는 대시보드를 볼 수 있다. 분단위로 조회 하였음으로 3 건 혹은 1건식 Detect 된 내용이 있음을 알 수 있다. 상세 내용을 보기 위해 Logs 를 클릭 하여 조회 조건 중 Action 에서 Detect 를 선택 하고 조회 한다. Detect 된 리스트를 볼 수 있으며 상세 각 라인별로 간략한 내용을 볼 수 있다. 접근을 시도한 지역과 User Agent 즉, 브라우저 정보를 볼 수 있다. 상세한 내용을 보기 위한 View JSON 을 클릭 한다. { &quot;action&quot;: &quot;DETECT&quot;, &quot;clientAddress&quot;: &quot;203.234.105.56&quot;, &quot;countryName&quot;: &quot;Republic of Korea&quot;, &quot;userAgent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0&quot;, &quot;domain&quot;: &quot;waf.korwaf.site&quot;, &quot;protectionRuleDetections&quot;: { &quot;959071&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: &#39; or &#39;1&#39;= found within ARGS:id: 1&#39; or &#39;1&#39;=&#39;1&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:\\\\bor\\\\b ?(?:\\\\d{1,10}|[\\\\&#39;\\\&quot;][^=]{1,10}[\\\\&#39;\\\&quot;]) ?[=&lt;&gt;]+|(?i:&#39;\\\\s+x?or\\\\s+.{1,20}[+\\\\-!&lt;&gt;=])|\\\\b(?i:x?or)\\\\b\\\\s+(\\\\d{1,10}|&#39;[^=]{1,10}&#39;)|\\\\b(?i:x?or)\\\\b\\\\s+(\\\\d{1,10}|&#39;[^=]{1,10}&#39;)\\\\s*?[=&lt;&gt;])\&quot; at ARGS:id.&quot; }, &quot;981242&quot;: { &quot;Message&quot;: &quot;Detects classic SQL injection probings 1/2. Matched attack string: [1&#39; or &#39;1&#39;=&#39;1] in [ARGS:id];&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:(?:[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\s*?(x?or|div|like|between|and)\\\\s*?[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]?\\\\d)|(?:\\\\\\\\x(?:23|27|3d))|(?:^.?[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]$)|(?:(?:^[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98\\\\\\\\]*?(?:[\\\\ ...\&quot; at ARGS:id.&quot; }, &quot;981243&quot;: { &quot;Message&quot;: &quot;Detects classic SQL injection probings 2/2. Matched attack string: [1&#39; or &#39;1&#39;=&#39;1] in [ARGS:id];&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:(?:[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\s*?\\\\*.+(?:x?or|div|like|between|and|id)\\\\W*?[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98]\\\\d)|(?:\\\\^[\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98])|(?:^[\\\\w\\\\s\\\&quot;&#39;`\\xc2\\xb4\\xe2\\x80\\x99\\xe2\\x80\\x98-]+(?&lt;=and\\\\s)(?&lt;=or|xor ...\&quot; at ARGS:id.&quot; } }, &quot;httpMethod&quot;: &quot;GET&quot;, &quot;requestUrl&quot;: &quot;/vulnerabilities/sqli/?id=1%27+or+%271%27%3D%271&amp;Submit=Submit&quot;, &quot;httpHeaders&quot;: { &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;en-US,en;q=0.5&quot;, &quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Connection&quot;: &quot;keep-alive&quot;, &quot;Cookie&quot;: &quot;PHPSESSID=d5ndqi2g5olrddv02qjp8bvdk0; security=low&quot;, &quot;Host&quot;: &quot;waf.korwaf.site&quot;, &quot;Referer&quot;: &quot;http://waf.korwaf.site/vulnerabilities/sqli/?id=admin%27+or+1%3D1+%23&amp;Submit=Submit&quot;, &quot;Request-Id&quot;: &quot;2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0&quot;, &quot;X-Client-Ip&quot;: &quot;203.234.105.56&quot;, &quot;X-Country-Code&quot;: &quot;KR&quot;, &quot;X-Forwarded-For&quot;: &quot;203.234.105.56&quot; }, &quot;httpVersion&quot;: &quot;HTTP/1.1&quot;, &quot;incidentKey&quot;: &quot;2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ&quot;, &quot;countryCode&quot;: &quot;KR&quot;, &quot;timestamp&quot;: &quot;Thu, 12 Mar 2020 12:26:13 GMT&quot;, &quot;logType&quot;: &quot;PROTECTION_RULES&quot; } 위 내용을 보고 접속한 클라이 언트의 상세 정보를 볼 수 있으며 protectionRuleDetections 을 보면 http://waf.korwaf.site/vulnerabilities/sqli 페이지에서 SQL Injection Attack 이 감지 된 것을 알 수 있으며 감지된 데이터는 ‘ or ‘1’= 이며 전달된 변수는 id 란 것을 알 수 있다. 다시 웹애플리케이션으로 돌아가 View Source를 클릭 하면 다음과 같은 코드로 작성되어 있음을 볼 수 있다. &lt;?php if( isset( $_REQUEST[ &#39;Submit&#39; ] ) ) { // Get input $id = $_REQUEST[ &#39;id&#39; ]; // Check database $query = &quot;SELECT first_name, last_name FROM users WHERE user_id = &#39;$id&#39;;&quot;; $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;], $query ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;/pre&gt;&#39; ); // Get results while( $row = mysqli_fetch_assoc( $result ) ) { // Get values $first = $row[&quot;first_name&quot;]; $last = $row[&quot;last_name&quot;]; // Feedback for end user echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;; } mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]); } ?&gt; SQL 실행이 $id 로 직접 웹페이지의 Query 파라미터를 받아 sql 문자열을 만든 후에 실행 되는 형태로 작성하여 SQL injection 공격에 취약해 진것을 볼 수 있다. 공격이 감지 되었음으로 코드를 수정하여 대비하거나 WAF 의 Protection Rule 의 Action을 block 으로 하여 해당 접근을 차단 할 수 있다. UNION based SQL Injection Detect Union based Injection 공격을 위해 웹애플리케이션의 SQL Injection을 클릭 한다. 공격을 위해 다음과 같이 union 을 포함하여 작성 한 후 submit 을 클릭 한다. &#39; union all select user_id as first_name, first_name from users # 결과는 다음과 같이 출력 된다. union all 로 원하는 SQL 을 실행 시켰으며 # 을 붙여 주어 뒤에 올 수 있는 SQL 문장을 주석으로 처리 하도록 한 것이다. 이로서 user_id는 1,2,3,4,5 가 있다는 것을 알 수 있다. WAF의 SQL Injection 감지 WAF Policies 의 logs 를 조회 하여 보면 Detect 가 된 요청을 볼 수 있다. View JSON 을 클릭 하면 아래와 같은 메시지를 볼 수 있으며 id 변수에 union all select user_id as first_name, first_name from users # 이란 변수가 전달 되어 SQL Injection 으로 의심되는 패턴이 입력 되어 감지 된 것을 알 수 있다. &quot;protectionRuleDetections&quot;: { &quot;950001&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: union all select found within ARGS:id: &#39; union all select user_id as first_name, first_name from users #&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:\\\\b(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4| ...\&quot; at ARGS:id.&quot; }, &quot;959073&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: union all select found within ARGS:id: &#39; union all select user_id as first_name, first_name from users #&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \&quot;(?i:(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4|ipv ...\&quot; at ARGS:id.&quot; } }," /><link rel="canonical" href="http://localhost:4000/edge/waf/sqlinjection/WAF-SQLInjection/" /><meta property="og:url" content="http://localhost:4000/edge/waf/sqlinjection/WAF-SQLInjection/" /><meta property="og:site_name" content="Jake Kim" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-12T00:50:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="WAF SQL Injection" /><meta name="twitter:site" content="@xers9" /><meta name="twitter:creator" content="@Jake Kim" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/edge/waf/sqlinjection/WAF-SQLInjection/"},"url":"http://localhost:4000/edge/waf/sqlinjection/WAF-SQLInjection/","author":{"@type":"Person","name":"Jake Kim"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/img/kyudong.kim.png"},"name":"Jake Kim"},"headline":"WAF SQL Injection","dateModified":"2020-03-12T00:50:00+09:00","datePublished":"2020-03-12T00:50:00+09:00","description":"OWASP SQL Injection 첫 번째로 WAF를 이용하여 SQL Injection 공격을 감지하고 이를 막는 방법을 알아보겠다. SQL 인젝션은 웹 사이트의 보안의 헛점을 이용하여 특정 SQL 쿼리 문을 전송하여 데이터베이스로 부터 데이터를 탈취하는 해킹 기법을 말한다. 클라이언트의 입력을 제대로 필터링 하지 못하여 발생하며 그 피해는 치명적일 수 있어 항상 가장 높은 위협 순위로 꼽히곤 한다. 예를 들어 사용자를 조회 하는 SQL과 웹페이지를 예로 들면 id를 받아서 테이블에서 조회하고 결과를 반환하는 형태일 것이다. 웹페이지는 아마도 http://**/user?id=gildong 형태로 조회 할 것이다. 실행 되는 SQL은 아마도 select id from user where id = ‘gildong’ 과 같을 것이다. 공격자는 SQL을 예측하여 쿼리를 수정하여 gildong’ or ‘1’=’1 형식으로 작성하면 실행되는 SQL은 select id from user where id = ‘gildong’ or ‘1’ = ‘1’ 로 변경되어 실행 되어 user 테이블로 부터 정보를 탈취할 수 있다. 이러한 공격 방법은 매우 다양하다. 다양한 공격 방법 중 2가지 전통적인 SQL injection 을 우선 소개 하겠다. Error based SQL Injection or ‘1’=’1’ 과 같은 문장을 추가 하여 항상 참이 되게 하여 공격하는 방법 이다. 로그인 과정에서 사용될 수 있는 Select * from user where id=’gildong’ and password=’abcd’ 를 예측하고 공격을 Select * from user where id=’gildong’ and password =’none’ or ‘1’=’1’ 이 실행되도록 하면 문장이 항상 참이기 때문에 로그인이 성공 하게 된다. UNION based SQL Injection SQL 의 Union 문장을 이용하여 추가 SQL이 실행 되도록 하는 공격 방법이다. 테이블의 정보를 탈취하고자 할 때 사용 될 수 있다. Select id from user where id=’gildong’ and password=’none’ union select id from user where ‘1’=’1’ 과 같이 변경하여 주면 모든 id를 조회 하게 된다. SQL Injection Detect WAF 를 이용한 SQL Injection 을 보기 위한 WAF 는 이전에 설정한 WAF 환경과 Web application (DVWA)를 이용할 것이다. 2개가 SQL Injection을 검출하기 위해 해당 공격을 감지 하도록 WAF의 Protect Rule을 설정 하여야 한다. OCI의 WAF 설정으로 들어간다. (Security 탭의 WAF Policies) WAF를 설정한 Compartment를 선택 하고 등록된 waf policy를 클릭 Protection Rules에서 SQL Injection의 Action을 Detect 로 변경 하여 준다. Classic SQL Injection probings, Common SQL Injects를 선택 하고 Detect를 선택 한다. 변경된 설정은 바로 적용되지 않고 unpublished 상태로 있게 된다. 변경이 감지되면 상단에 unpublished list에 나오게 되며 Publish All 버튼을 눌러주면 글로벌하게 변경된 정책이 적용 된다. 변경된 정책의 적용에 수분이 소요 됨으로 잠시 대기 하여 준다. 적용이 완료 되면 Active 상태가 된다. Error based SQL Injection Attack SQL Injection 공격을 위해 웹애플리케이션에 로그인 한다. http://waf.korwaf.site/ 에 로그인 하면 메뉴 중 SQL Injection을 클릭 한다. 공격을 위해 1을 입력 하고 Submit을 누르면 아래 처럼 1번에 대한 사용자 정보가 출력 되는 것을 볼 수 있다. 공격을 위해 다음과 같이 입력 하고 Submit을 클릭 하면 1&#39; or &#39;1&#39;=&#39;1&#39; 아래 처럼 테이블에 정보가 조회 되는 것을 볼 수 있다. 이로서 테이블에는 admin, Gordon, Hack, Pablo, Bob 등이 있다는 것을 알 수 있다 WAF의 SQL Injection 감지 WAF Policies에서 Metrics 를 보면 Detect 된 요청의 건수를 보여주는 대시보드를 볼 수 있다. 분단위로 조회 하였음으로 3 건 혹은 1건식 Detect 된 내용이 있음을 알 수 있다. 상세 내용을 보기 위해 Logs 를 클릭 하여 조회 조건 중 Action 에서 Detect 를 선택 하고 조회 한다. Detect 된 리스트를 볼 수 있으며 상세 각 라인별로 간략한 내용을 볼 수 있다. 접근을 시도한 지역과 User Agent 즉, 브라우저 정보를 볼 수 있다. 상세한 내용을 보기 위한 View JSON 을 클릭 한다. { &quot;action&quot;: &quot;DETECT&quot;, &quot;clientAddress&quot;: &quot;203.234.105.56&quot;, &quot;countryName&quot;: &quot;Republic of Korea&quot;, &quot;userAgent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0&quot;, &quot;domain&quot;: &quot;waf.korwaf.site&quot;, &quot;protectionRuleDetections&quot;: { &quot;959071&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: &#39; or &#39;1&#39;= found within ARGS:id: 1&#39; or &#39;1&#39;=&#39;1&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \\&quot;(?i:\\\\\\\\bor\\\\\\\\b ?(?:\\\\\\\\d{1,10}|[\\\\\\\\&#39;\\\\\\&quot;][^=]{1,10}[\\\\\\\\&#39;\\\\\\&quot;]) ?[=&lt;&gt;]+|(?i:&#39;\\\\\\\\s+x?or\\\\\\\\s+.{1,20}[+\\\\\\\\-!&lt;&gt;=])|\\\\\\\\b(?i:x?or)\\\\\\\\b\\\\\\\\s+(\\\\\\\\d{1,10}|&#39;[^=]{1,10}&#39;)|\\\\\\\\b(?i:x?or)\\\\\\\\b\\\\\\\\s+(\\\\\\\\d{1,10}|&#39;[^=]{1,10}&#39;)\\\\\\\\s*?[=&lt;&gt;])\\&quot; at ARGS:id.&quot; }, &quot;981242&quot;: { &quot;Message&quot;: &quot;Detects classic SQL injection probings 1/2. Matched attack string: [1&#39; or &#39;1&#39;=&#39;1] in [ARGS:id];&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \\&quot;(?i:(?:[\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98]\\\\\\\\s*?(x?or|div|like|between|and)\\\\\\\\s*?[\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98]?\\\\\\\\d)|(?:\\\\\\\\\\\\\\\\x(?:23|27|3d))|(?:^.?[\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98]$)|(?:(?:^[\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98\\\\\\\\\\\\\\\\]*?(?:[\\\\\\\\ ...\\&quot; at ARGS:id.&quot; }, &quot;981243&quot;: { &quot;Message&quot;: &quot;Detects classic SQL injection probings 2/2. Matched attack string: [1&#39; or &#39;1&#39;=&#39;1] in [ARGS:id];&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \\&quot;(?i:(?:[\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98]\\\\\\\\s*?\\\\\\\\*.+(?:x?or|div|like|between|and|id)\\\\\\\\W*?[\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98]\\\\\\\\d)|(?:\\\\\\\\^[\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98])|(?:^[\\\\\\\\w\\\\\\\\s\\\\\\&quot;&#39;`\\\\xc2\\\\xb4\\\\xe2\\\\x80\\\\x99\\\\xe2\\\\x80\\\\x98-]+(?&lt;=and\\\\\\\\s)(?&lt;=or|xor ...\\&quot; at ARGS:id.&quot; } }, &quot;httpMethod&quot;: &quot;GET&quot;, &quot;requestUrl&quot;: &quot;/vulnerabilities/sqli/?id=1%27+or+%271%27%3D%271&amp;Submit=Submit&quot;, &quot;httpHeaders&quot;: { &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;en-US,en;q=0.5&quot;, &quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Connection&quot;: &quot;keep-alive&quot;, &quot;Cookie&quot;: &quot;PHPSESSID=d5ndqi2g5olrddv02qjp8bvdk0; security=low&quot;, &quot;Host&quot;: &quot;waf.korwaf.site&quot;, &quot;Referer&quot;: &quot;http://waf.korwaf.site/vulnerabilities/sqli/?id=admin%27+or+1%3D1+%23&amp;Submit=Submit&quot;, &quot;Request-Id&quot;: &quot;2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0&quot;, &quot;X-Client-Ip&quot;: &quot;203.234.105.56&quot;, &quot;X-Country-Code&quot;: &quot;KR&quot;, &quot;X-Forwarded-For&quot;: &quot;203.234.105.56&quot; }, &quot;httpVersion&quot;: &quot;HTTP/1.1&quot;, &quot;incidentKey&quot;: &quot;2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ&quot;, &quot;countryCode&quot;: &quot;KR&quot;, &quot;timestamp&quot;: &quot;Thu, 12 Mar 2020 12:26:13 GMT&quot;, &quot;logType&quot;: &quot;PROTECTION_RULES&quot; } 위 내용을 보고 접속한 클라이 언트의 상세 정보를 볼 수 있으며 protectionRuleDetections 을 보면 http://waf.korwaf.site/vulnerabilities/sqli 페이지에서 SQL Injection Attack 이 감지 된 것을 알 수 있으며 감지된 데이터는 ‘ or ‘1’= 이며 전달된 변수는 id 란 것을 알 수 있다. 다시 웹애플리케이션으로 돌아가 View Source를 클릭 하면 다음과 같은 코드로 작성되어 있음을 볼 수 있다. &lt;?php if( isset( $_REQUEST[ &#39;Submit&#39; ] ) ) { // Get input $id = $_REQUEST[ &#39;id&#39; ]; // Check database $query = &quot;SELECT first_name, last_name FROM users WHERE user_id = &#39;$id&#39;;&quot;; $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;], $query ) or die( &#39;&lt;pre&gt;&#39; . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . &#39;&lt;/pre&gt;&#39; ); // Get results while( $row = mysqli_fetch_assoc( $result ) ) { // Get values $first = $row[&quot;first_name&quot;]; $last = $row[&quot;last_name&quot;]; // Feedback for end user echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;; } mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]); } ?&gt; SQL 실행이 $id 로 직접 웹페이지의 Query 파라미터를 받아 sql 문자열을 만든 후에 실행 되는 형태로 작성하여 SQL injection 공격에 취약해 진것을 볼 수 있다. 공격이 감지 되었음으로 코드를 수정하여 대비하거나 WAF 의 Protection Rule 의 Action을 block 으로 하여 해당 접근을 차단 할 수 있다. UNION based SQL Injection Detect Union based Injection 공격을 위해 웹애플리케이션의 SQL Injection을 클릭 한다. 공격을 위해 다음과 같이 union 을 포함하여 작성 한 후 submit 을 클릭 한다. &#39; union all select user_id as first_name, first_name from users # 결과는 다음과 같이 출력 된다. union all 로 원하는 SQL 을 실행 시켰으며 # 을 붙여 주어 뒤에 올 수 있는 SQL 문장을 주석으로 처리 하도록 한 것이다. 이로서 user_id는 1,2,3,4,5 가 있다는 것을 알 수 있다. WAF의 SQL Injection 감지 WAF Policies 의 logs 를 조회 하여 보면 Detect 가 된 요청을 볼 수 있다. View JSON 을 클릭 하면 아래와 같은 메시지를 볼 수 있으며 id 변수에 union all select user_id as first_name, first_name from users # 이란 변수가 전달 되어 SQL Injection 으로 의심되는 패턴이 입력 되어 감지 된 것을 알 수 있다. &quot;protectionRuleDetections&quot;: { &quot;950001&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: union all select found within ARGS:id: &#39; union all select user_id as first_name, first_name from users #&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \\&quot;(?i:\\\\\\\\b(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4| ...\\&quot; at ARGS:id.&quot; }, &quot;959073&quot;: { &quot;Message&quot;: &quot;SQL Injection Attack. Matched Data: union all select found within ARGS:id: &#39; union all select user_id as first_name, first_name from users #&quot;, &quot;Message details&quot;: &quot;Warning. Pattern match \\&quot;(?i:(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4|ipv ...\\&quot; at ARGS:id.&quot; } },","@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --><title>WAF SQL Injection</title><link rel="icon" type="image/png" href="?s=16" sizes="16x16"><link rel="icon" type="image/png" href="?s=32" sizes="32x32"><link rel="icon" type="image/png" href="?s=96" sizes="96x96"><link rel="shortcut icon" href=""><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Jake Kim" /></head><body> <svg xmlns="http://www.w3.org/2000/svg" style="height: 0; position: absolute" xmlns:xlink="http://www.w3.org/1999/xlink"> <symbol id="flickr" viewbox="0 0 16 16"><path d="M0 8c0 2.05 1.662 3.71 3.71 3.71 2.05 0 3.713-1.66 3.713-3.71S5.76 4.29 3.71 4.29C1.663 4.29 0 5.95 0 8zm8.577 0c0 2.05 1.662 3.71 3.712 3.71C14.337 11.71 16 10.05 16 8s-1.662-3.71-3.71-3.71c-2.05 0-3.713 1.66-3.713 3.71z"></path></symbol> <symbol id="github" viewbox="0 0 16 16"><path d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.083-.202-.358-1.015.077-2.117 0 0 .672-.215 2.2.82.638-.178 1.323-.266 2.003-.27.68.004 1.364.092 2.003.27 1.527-1.035 2.198-.82 2.198-.82.437 1.102.163 1.915.08 2.117.513.56.823 1.274.823 2.147 0 3.073-1.87 3.75-3.653 3.947.287.246.543.735.543 1.48 0 1.07-.01 1.933-.01 2.195 0 .215.144.463.55.385C13.71 14.53 16 11.534 16 8c0-4.418-3.582-8-8-8"></path></symbol> <symbol id="linkedin" viewbox="0 0 16 16"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero"></path></symbol> <symbol id="rss" viewbox="0 0 16 16"><path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194 11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.985 2.194-2.196 2.194C.984 16 0 15.017 0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"></path></symbol> <symbol id="twitter" viewbox="0 0 16 16"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.375-1.337.648-2.085.795-.598-.638-1.45-1.036-2.396-1.036-1.812 0-3.282 1.468-3.282 3.28 0 .258.03.51.085.75C5.152 5.39 2.733 4.084 1.114 2.1.83 2.583.67 3.147.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.416-.02-.617-.058.418 1.304 1.63 2.253 3.067 2.28-1.124.88-2.54 1.404-4.077 1.404-.265 0-.526-.015-.783-.045 1.453.93 3.178 1.474 5.032 1.474 6.038 0 9.34-5 9.34-9.338 0-.143-.004-.284-.01-.425.64-.463 1.198-1.04 1.638-1.7z" fill-rule="nonzero"></path></symbol> <symbol id="email" viewbox="0 0 16 11"><path fill-rule="evenodd" d="M1.33 0h13.34L8 5 1.33 0zM16 0v11H0V0l8 6 8-6z"></path></symbol> </svg><header class="header"><div class="container"> <a class="logo" href="http://localhost:4000" title="Jake Kim"><img src="/assets/img/kyudong.kim.png" alt="Jake Kim logo"></a><nav class="nav nav--header"><ul class="list list--nav">
<li class="item item--nav"><a href="/">Home</a></li>
<li class="item item--nav"><a href="/blog/">Blog</a></li>
</ul></nav>
</div></header><!--collect all blog tags http://longqian.me/2017/02/09/github-jekyll-tag/ --><main class="main container"><article class="content typeset"><h1>WAF SQL Injection</h1>
<small class="small post-meta"> <span class="label label--category"> </span> <time datetime="2020-03-12T00:50:00+09:00" class="time"> 12 Mar 2020 </time> </small><div style="padding-bottom: 3%">
<h1 id="owasp-sql-injection">OWASP SQL Injection</h1>
<p>첫 번째로 WAF를 이용하여 SQL Injection 공격을 감지하고 이를 막는 방법을 알아보겠다. SQL 인젝션은 웹 사이트의 보안의 헛점을 이용하여 특정 SQL 쿼리 문을 전송하여 데이터베이스로 부터 데이터를 탈취하는 해킹 기법을 말한다. 클라이언트의 입력을 제대로 필터링 하지 못하여 발생하며 그 피해는 치명적일 수 있어 항상 가장 높은 위협 순위로 꼽히곤 한다. 예를 들어 사용자를 조회 하는 SQL과 웹페이지를 예로 들면 id를 받아서 테이블에서 조회하고 결과를 반환하는 형태일 것이다. 웹페이지는 아마도 http://<strong>**</strong>/user?id=gildong 형태로 조회 할 것이다. <br> <img src="/image/waf-sqlinjection/waf-01.png" alt=""></p>
<p>실행 되는 SQL은 아마도 select id from user where id = ‘gildong’ 과 같을 것이다. 공격자는 SQL을 예측하여 쿼리를 수정하여 gildong’ or ‘1’=’1 형식으로 작성하면 실행되는 SQL은 select id from user where id = ‘gildong’ or ‘1’ = ‘1’ 로 변경되어 실행 되어 user 테이블로 부터 정보를 탈취할 수 있다.</p>
<p>이러한 공격 방법은 매우 다양하다. 다양한 공격 방법 중 2가지 전통적인 SQL injection 을 우선 소개 하겠다.</p>
<h4 id="error-based-sql-injection">Error based SQL Injection</h4>
<p>or ‘1’=’1’ 과 같은 문장을 추가 하여 항상 참이 되게 하여 공격하는 방법 이다. 로그인 과정에서 사용될 수 있는 Select * from user where id=’gildong’ and password=’abcd’ 를 예측하고 공격을 Select * from user where id=’gildong’ and password =’none’ or ‘1’=’1’ 이 실행되도록 하면 문장이 항상 참이기 때문에 로그인이 성공 하게 된다.</p>
<h4 id="union-based-sql-injection">UNION based SQL Injection</h4>
<p>SQL 의 Union 문장을 이용하여 추가 SQL이 실행 되도록 하는 공격 방법이다. 테이블의 정보를 탈취하고자 할 때 사용 될 수 있다. Select id from user where id=’gildong’ and password=’none’ union select id from user where ‘1’=’1’ 과 같이 변경하여 주면 모든 id를 조회 하게 된다.</p>
<h1 id="sql-injection-detect">SQL Injection Detect</h1>
<p>WAF 를 이용한 SQL Injection 을 보기 위한 WAF 는 이전에 설정한 WAF 환경과 Web application (DVWA)를 이용할 것이다.<br> 2개가 SQL Injection을 검출하기 위해 해당 공격을 감지 하도록 WAF의 Protect Rule을 설정 하여야 한다. OCI의 WAF 설정으로 들어간다. (Security 탭의 WAF Policies) WAF를 설정한 Compartment를 선택 하고 등록된 waf policy를 클릭</p>
<p><img src="/image/waf-sqlinjection/waf-02.png" alt=""></p>
<p>Protection Rules에서 SQL Injection의 Action을 Detect 로 변경 하여 준다. Classic SQL Injection probings, Common SQL Injects를 선택 하고 Detect를 선택 한다.</p>
<p><img src="/image/waf-sqlinjection/waf-03.png" alt=""></p>
<p>변경된 설정은 바로 적용되지 않고 unpublished 상태로 있게 된다. 변경이 감지되면 상단에 unpublished list에 나오게 되며 Publish All 버튼을 눌러주면 글로벌하게 변경된 정책이 적용 된다. <br> <img src="/image/waf-sqlinjection/waf-04.png" alt=""></p>
<p>변경된 정책의 적용에 수분이 소요 됨으로 잠시 대기 하여 준다. 적용이 완료 되면 Active 상태가 된다.</p>
<h1 id="error-based-sql-injection-attack">Error based SQL Injection Attack</h1>
<p>SQL Injection 공격을 위해 웹애플리케이션에 로그인 한다. http://waf.korwaf.site/ 에 로그인 하면 메뉴 중 SQL Injection을 클릭 한다. 공격을 위해 1을 입력 하고 Submit을 누르면 아래 처럼 1번에 대한 사용자 정보가 출력 되는 것을 볼 수 있다. <br> <img src="/image/waf-sqlinjection/waf-05.png" alt=""></p>
<p>공격을 위해 다음과 같이 입력 하고 Submit을 클릭 하면</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1<span class="s1">' or '</span>1<span class="s1">'='</span>1<span class="s1">'    
</span></code></pre></div></div>
<p>아래 처럼 테이블에 정보가 조회 되는 것을 볼 수 있다.</p>
<p><img src="/image/waf-sqlinjection/waf-06.png" alt=""></p>
<p>이로서 테이블에는 admin, Gordon, Hack, Pablo, Bob 등이 있다는 것을 알 수 있다</p>
<h4 id="waf의-sql-injection-감지">WAF의 SQL Injection 감지</h4>
<p>WAF Policies에서 Metrics 를 보면 Detect 된 요청의 건수를 보여주는 대시보드를 볼 수 있다. 분단위로 조회 하였음으로 3 건 혹은 1건식 Detect 된 내용이 있음을 알 수 있다.</p>
<p><img src="/image/waf-sqlinjection/waf-07.png" alt=""></p>
<p>상세 내용을 보기 위해 Logs 를 클릭 하여 조회 조건 중 Action 에서 Detect 를 선택 하고 조회 한다. Detect 된 리스트를 볼 수 있으며 상세 각 라인별로 간략한 내용을 볼 수 있다.</p>
<p><img src="/image/waf-sqlinjection/waf-08.png" alt=""></p>
<p>접근을 시도한 지역과 User Agent 즉, 브라우저 정보를 볼 수 있다. 상세한 내용을 보기 위한 View JSON 을 클릭 한다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DETECT"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clientAddress"</span><span class="p">:</span><span class="w"> </span><span class="s2">"203.234.105.56"</span><span class="p">,</span><span class="w"> 
  </span><span class="nl">"countryName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Republic of Korea"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"userAgent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"domain"</span><span class="p">:</span><span class="w"> </span><span class="s2">"waf.korwaf.site"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"protectionRuleDetections"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"959071"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SQL Injection Attack. Matched Data: ' or '1'= found within ARGS:id: 1' or '1'='1"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Message details"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning. Pattern match </span><span class="se">\"</span><span class="s2">(?i:</span><span class="se">\\\\</span><span class="s2">bor</span><span class="se">\\\\</span><span class="s2">b ?(?:</span><span class="se">\\\\</span><span class="s2">d{1,10}|[</span><span class="se">\\\\</span><span class="s2">'</span><span class="se">\\\"</span><span class="s2">][^=]{1,10}[</span><span class="se">\\\\</span><span class="s2">'</span><span class="se">\\\"</span><span class="s2">]) ?[=&lt;&gt;]+|(?i:'</span><span class="se">\\\\</span><span class="s2">s+x?or</span><span class="se">\\\\</span><span class="s2">s+.{1,20}[+</span><span class="se">\\\\</span><span class="s2">-!&lt;&gt;=])|</span><span class="se">\\\\</span><span class="s2">b(?i:x?or)</span><span class="se">\\\\</span><span class="s2">b</span><span class="se">\\\\</span><span class="s2">s+(</span><span class="se">\\\\</span><span class="s2">d{1,10}|'[^=]{1,10}')|</span><span class="se">\\\\</span><span class="s2">b(?i:x?or)</span><span class="se">\\\\</span><span class="s2">b</span><span class="se">\\\\</span><span class="s2">s+(</span><span class="se">\\\\</span><span class="s2">d{1,10}|'[^=]{1,10}')</span><span class="se">\\\\</span><span class="s2">s*?[=&lt;&gt;])</span><span class="se">\"</span><span class="s2"> at ARGS:id."</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"981242"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Detects classic SQL injection probings 1/2. Matched attack string: [1' or '1'='1] in [ARGS:id];"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Message details"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning. Pattern match </span><span class="se">\"</span><span class="s2">(?i:(?:[</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98]</span><span class="se">\\\\</span><span class="s2">s*?(x?or|div|like|between|and)</span><span class="se">\\\\</span><span class="s2">s*?[</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98]?</span><span class="se">\\\\</span><span class="s2">d)|(?:</span><span class="se">\\\\\\\\</span><span class="s2">x(?:23|27|3d))|(?:^.?[</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98]$)|(?:(?:^[</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98</span><span class="se">\\\\\\\\</span><span class="s2">]*?(?:[</span><span class="se">\\\\</span><span class="s2"> ...</span><span class="se">\"</span><span class="s2"> at ARGS:id."</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"981243"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Detects classic SQL injection probings 2/2. Matched attack string: [1' or '1'='1] in [ARGS:id];"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Message details"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning. Pattern match </span><span class="se">\"</span><span class="s2">(?i:(?:[</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98]</span><span class="se">\\\\</span><span class="s2">s*?</span><span class="se">\\\\</span><span class="s2">*.+(?:x?or|div|like|between|and|id)</span><span class="se">\\\\</span><span class="s2">W*?[</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98]</span><span class="se">\\\\</span><span class="s2">d)|(?:</span><span class="se">\\\\</span><span class="s2">^[</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98])|(?:^[</span><span class="se">\\\\</span><span class="s2">w</span><span class="se">\\\\</span><span class="s2">s</span><span class="se">\\\"</span><span class="s2">'`</span><span class="se">\\</span><span class="s2">xc2</span><span class="se">\\</span><span class="s2">xb4</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x99</span><span class="se">\\</span><span class="s2">xe2</span><span class="se">\\</span><span class="s2">x80</span><span class="se">\\</span><span class="s2">x98-]+(?&lt;=and</span><span class="se">\\\\</span><span class="s2">s)(?&lt;=or|xor ...</span><span class="se">\"</span><span class="s2"> at ARGS:id."</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"httpMethod"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"requestUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/vulnerabilities/sqli/?id=1%27+or+%271%27%3D%271&amp;Submit=Submit"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"httpHeaders"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Accept"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Accept-Encoding"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gzip, deflate"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Accept-Language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en-US,en;q=0.5"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Cache-Control"</span><span class="p">:</span><span class="w"> </span><span class="s2">"max-age=0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Connection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keep-alive"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Cookie"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PHPSESSID=d5ndqi2g5olrddv02qjp8bvdk0; security=low"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"waf.korwaf.site"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Referer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://waf.korwaf.site/vulnerabilities/sqli/?id=admin%27+or+1%3D1+%23&amp;Submit=Submit"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Request-Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Upgrade-Insecure-Requests"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"User-Agent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"X-Client-Ip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"203.234.105.56"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"X-Country-Code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"KR"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"X-Forwarded-For"</span><span class="p">:</span><span class="w"> </span><span class="s2">"203.234.105.56"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"httpVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HTTP/1.1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"incidentKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-03-12T12:26:13Z|8a3fcdc114|203.234.105.56|DSLYxGAAHQ"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"countryCode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"KR"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Thu, 12 Mar 2020 12:26:13 GMT"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"logType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PROTECTION_RULES"</span><span class="w">
</span><span class="p">}</span><span class="w">   
</span></code></pre></div></div>
<p>위 내용을 보고 접속한 클라이 언트의 상세 정보를 볼 수 있으며 protectionRuleDetections 을 보면 http://waf.korwaf.site/vulnerabilities/sqli 페이지에서 SQL Injection Attack 이 감지 된 것을 알 수 있으며 감지된 데이터는 ‘ or ‘1’= 이며 전달된 변수는 id 란 것을 알 수 있다.</p>
<p>다시 웹애플리케이션으로 돌아가 View Source를 클릭 하면 다음과 같은 코드로 작성되어 있음을 볼 수 있다.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">if</span><span class="p">(</span> <span class="nb">isset</span><span class="p">(</span> <span class="nv">$_REQUEST</span><span class="p">[</span> <span class="s1">'Submit'</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Get input</span>
    <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span> <span class="s1">'id'</span> <span class="p">];</span>

    <span class="c1">// Check database</span>
    <span class="nv">$query</span>  <span class="o">=</span> <span class="s2">"SELECT first_name, last_name FROM users WHERE user_id = '</span><span class="nv">$id</span><span class="s2">';"</span><span class="p">;</span>
    <span class="nv">$result</span> <span class="o">=</span> <span class="nx">mysqli_query</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s2">"___mysqli_ston"</span><span class="p">],</span>  <span class="nv">$query</span> <span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span> <span class="s1">'&lt;pre&gt;'</span> <span class="o">.</span> <span class="p">((</span><span class="nb">is_object</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s2">"___mysqli_ston"</span><span class="p">]))</span> <span class="o">?</span> <span class="nx">mysqli_error</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s2">"___mysqli_ston"</span><span class="p">])</span> <span class="o">:</span> <span class="p">((</span><span class="nv">$___mysqli_res</span> <span class="o">=</span> <span class="nx">mysqli_connect_error</span><span class="p">())</span> <span class="o">?</span> <span class="nv">$___mysqli_res</span> <span class="o">:</span> <span class="kc">false</span><span class="p">))</span> <span class="o">.</span> <span class="s1">'&lt;/pre&gt;'</span> <span class="p">);</span>

    <span class="c1">// Get results</span>
    <span class="k">while</span><span class="p">(</span> <span class="nv">$row</span> <span class="o">=</span> <span class="nx">mysqli_fetch_assoc</span><span class="p">(</span> <span class="nv">$result</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Get values</span>
        <span class="nv">$first</span> <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s2">"first_name"</span><span class="p">];</span>
        <span class="nv">$last</span>  <span class="o">=</span> <span class="nv">$row</span><span class="p">[</span><span class="s2">"last_name"</span><span class="p">];</span>

        <span class="c1">// Feedback for end user</span>
        <span class="k">echo</span> <span class="s2">"&lt;pre&gt;ID: </span><span class="si">{</span><span class="nv">$id</span><span class="si">}</span><span class="s2">&lt;br /&gt;First name: </span><span class="si">{</span><span class="nv">$first</span><span class="si">}</span><span class="s2">&lt;br /&gt;Surname: </span><span class="si">{</span><span class="nv">$last</span><span class="si">}</span><span class="s2">&lt;/pre&gt;"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">mysqli_close</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s2">"___mysqli_ston"</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">?&gt;</span> 
</code></pre></div></div>
<p>SQL 실행이 $id 로 직접 웹페이지의 Query 파라미터를 받아 sql 문자열을 만든 후에 실행 되는 형태로 작성하여 SQL injection 공격에 취약해 진것을 볼 수 있다. 공격이 감지 되었음으로 코드를 수정하여 대비하거나 WAF 의 Protection Rule 의 Action을 block 으로 하여 해당 접근을 차단 할 수 있다.</p>
<h1 id="union-based-sql-injection-detect">UNION based SQL Injection Detect</h1>
<p>Union based Injection 공격을 위해 웹애플리케이션의 SQL Injection을 클릭 한다. 공격을 위해 다음과 같이 union 을 포함하여 작성 한 후 submit 을 클릭 한다.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' union all select user_id as first_name, first_name from users #
</span></code></pre></div></div>
<p>결과는 다음과 같이 출력 된다.</p>
<p><img src="/image/waf-sqlinjection/waf-09.png" alt=""> union all 로 원하는 SQL 을 실행 시켰으며 # 을 붙여 주어 뒤에 올 수 있는 SQL 문장을 주석으로 처리 하도록 한 것이다. 이로서 user_id는 1,2,3,4,5 가 있다는 것을 알 수 있다.</p>
<h4 id="waf의-sql-injection-감지-1">WAF의 SQL Injection 감지</h4>
<p>WAF Policies 의 logs 를 조회 하여 보면 Detect 가 된 요청을 볼 수 있다.</p>
<p><img src="/image/waf-sqlinjection/waf-10.png" alt=""></p>
<p>View JSON 을 클릭 하면 아래와 같은 메시지를 볼 수 있으며 id 변수에 union all select user_id as first_name, first_name from users # 이란 변수가 전달 되어 SQL Injection 으로 의심되는 패턴이 입력 되어 감지 된 것을 알 수 있다.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"protectionRuleDetections"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"950001"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SQL Injection Attack. Matched Data: union all select found within ARGS:id: ' union all select user_id as first_name, first_name from users #"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Message details"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning. Pattern match </span><span class="se">\"</span><span class="s2">(?i:</span><span class="se">\\\\</span><span class="s2">b(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4| ...</span><span class="se">\"</span><span class="s2"> at ARGS:id."</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"959073"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SQL Injection Attack. Matched Data: union all select found within ARGS:id: ' union all select user_id as first_name, first_name from users #"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Message details"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warning. Pattern match </span><span class="se">\"</span><span class="s2">(?i:(?:(?:s(?:t(?:d(?:dev(_pop|_samp)?)?|r(?:_to_date|cmp))|u(?:b(?:str(?:ing(_index)?)?|(?:dat|tim)e)|m)|e(?:c(?:_to_time|ond)|ssion_user)|ys(?:tem_user|date)|ha(1|2)?|oundex|chema|ig?n|pace|qrt)|i(?:s(null|_(free_lock|ipv4_compat|ipv4_mapped|ipv4|ipv ...</span><span class="se">\"</span><span class="s2"> at ARGS:id."</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
</div></article><aside class="aside typeset"><h4>Related Posts</h4>
<ul class="list list--posts">
<li class="item item--post"><div class="typeset">
<h4><a href="/edge/dns/dns-service3/">DNS 이전하기</a></h4>
<small class="small post-meta"> <time datetime="2021-03-12T15:02:00+09:00" class="time"> 12 Mar 2021 </time> </small> <span><br><h1 id="oracle-dns-management">Oracle DNS Management</h1>
<p>오라클 DNS는 클라우드 기반 도메인 네임서비스로...</p></span>
</div></li>
<li class="item item--post"><div class="typeset">
<h4><a href="/edge/waf/sqlinjection/WAF-SQLBlindInjection/">WAF SQL Blind Injection</a></h4>
<small class="small post-meta"> <time datetime="2020-03-13T13:00:00+09:00" class="time"> 13 Mar 2020 </time> </small> <span><br><h1 id="owasp-sql-blind-injection">OWASP SQL Blind Injection</h1>
<p>이전의 SQL Injection 공격은 SQL을...</p></span>
</div></li>
<li class="item item--post"><div class="typeset">
<h4><a href="/edge/waf/WAF-register/">WAF 등록</a></h4>
<small class="small post-meta"> <time datetime="2020-03-08T19:46:00+09:00" class="time"> 08 Mar 2020 </time> </small> <span><br><h1 id="web-application-firewall">Web Application firewall</h1>
<p>웹애플리케이션 방화벽(이하 WAF)은 기존 방화벽이 네트워크의...</p></span>
</div></li>
</ul>
<a class="button" href="/feed.xml" title="Subscribe">Subscribe  <svg class="icon" role="img"><use xlink:href="#rss"></use></svg></a><nav class="nav nav--social"><h6>Contact me:</h6>
<a class="link" target="_blank" href="https://github.com/xers989" title="github"><svg class="icon" role="img"><use xlink:href="#github"></use></svg></a> <a class="link" target="_blank" href="https://www.linkedin.com/in/kyudong-kim-80778033/" title="linkedin"><svg class="icon" role="img"><use xlink:href="#linkedin"></use></svg></a></nav></aside></main><script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-93479534-1', 'auto'); ga('send', 'pageview'); </script><footer class="footer"><div class="container">
<nav class="nav nav--footer"><ul class="list list--nav"><li class="item item--nav"> <a href="https://alembic.darn.es/">Adopted Alembic Theme</a>
</li></ul></nav><div class="copyright typeset"> <small style="color:white;">© Jake Kim 2021</small>
</div>
</div></footer></body><link rel="stylesheet" href="/assets/styles.css"><link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet"></html>
